#! /usr/bin/env ruby
$KCODE = 'utf-8'

$:.unshift(File.dirname(__FILE__) + '/../lib')
require 'rencon'
require 'pit'

config = Pit.get("redmine_sa", :require => {
  "username" => "you email in ldap",
  "password" => "your password in ldap",
  "realname" => "your name in redmine",
})

CONFIG = {
  :host     => ARGV[0],
  :user     => config["username"],
  :pass     => config["password"],
  :name     => config["realname"],
  :per_page => 50,
}

if FileTest.exists? ENV['HOME'] + '/.rencon'
  load ENV['HOME'] + '/.rencon'
  PROJECTS = PROJECT_DEFS[CONFIG[:host]]
else
  PROJECTS = []
end

PROJECT = PROJECTS.find {|proj| proj =~ /#{ARGV[1]}/ }

if PROJECT.nil?
  warn 'project was not found'
  exit 1
end

rencon = Rencon::Core.new CONFIG
mark = rencon.lambda_mark
tickets, title = rencon.retrieve PROJECT
tickets.map {|issue| issue[0].sub!(/\A/, '#') }
ticket_list = tickets.map {|row| row.values_at(0, 5).unshift(mark[row[6]]) * ' ' }

puts title
puts '-' * 18
puts ticket_list
